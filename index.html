<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quay Crane (QC) Inspection Checklist - Complete Form</title>

  <!-- ✅ Libraries for AUTOMATIC PDF (Option 1) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{
      font-family: Arial, Helvetica, sans-serif;
      background:#f4f6f8;
      padding:20px;
      color:#000;
    }
    .page{
      max-width: 1200px;
      margin:auto;
      background:#fff;
      border:1px solid #000;
      padding:18px;
      position:relative;
      min-height: calc(100vh - 40px);
      padding-bottom:160px;
    }

    .header{ margin:6px 0 18px; text-align:center; }
    .header .org{
      font-size:18px; font-weight:700;
      color:#6b6b6b; text-align:left;
    }
    .header .title{
      font-size:15px; font-weight:700;
      text-decoration:underline; margin-top:10px; text-align:center;
    }

    .meta{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin: 14px 0 12px;
    }
    .field label{ font-size:12px; font-weight:700; display:block; margin-bottom:4px; }
    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%;
      border:1px solid #666;
      border-radius:4px;
      padding:6px;
      font-size:13px;
      box-sizing:border-box;
    }
    textarea{ min-height:58px; resize:vertical; overflow:auto; }

    .locked{ background:#f2f2f2; pointer-events:none; }

    .section-title{
      text-align:center;
      font-weight:700;
      margin:18px 0 8px;
      background:#e8f1fb;
      border:1px solid #0b4f8a;
      color:#0b4f8a;
      padding:6px 10px;
      text-decoration:none;
    }

    table{ width:100%; border-collapse:collapse; }
    th, td{ border:1px solid #000; padding:8px; font-size:13px; vertical-align:top; }
    th{ background:#f2f2f2 !important; color:#1f2937; }
    .center{ text-align:center; }
    .w-sn{ width:55px; }
    .w-cond{ width:220px; }
    .w-photo{ width:240px; }
    .w-status{ width:140px; }

    .opt{ margin-right:10px; white-space:nowrap; display:inline-block; }

    .photo-cell{
      border:1px dashed #777;
      padding:6px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .photo-cell input[type="file"]{ width:100%; font-size:12px; }
    .thumb{
      height:110px;
      border:1px solid #bbb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:#666;
      overflow:hidden;
      background:#fff;
    }
    .thumb img{ width:100%; height:100%; object-fit:contain; }

    .obs-ta, .rec-ta{ height:110px; min-height:110px; max-height:220px; }
    .chk-remarks{ height:70px; min-height:70px; max-height:160px; }

    .sign-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:10px; }
    .sigbox{ border:1px solid #000; padding:10px; }
    canvas{
      width:100%;
      height:130px;
      border:1px solid #000;
      border-radius:6px;
      background:#fff;
      touch-action:none;
    }

    button{
      padding:8px 14px;
      font-size:14px;
      border:1px solid #0b4f8a;
      background:#0b4f8a;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
    }
    button.secondary{
      background:#fff;
      color:#0b4f8a;
      border-color:#0b4f8a;
    }
    button.danger{
      background:#c0392b;
      border-color:#c0392b;
      color:#fff;
    }
    button.secondary.danger{
      background:#fff;
      color:#c0392b;
      border-color:#c0392b;
    }

    .actions{
      margin-top:18px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Header logo */
    .header-with-logo{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:16px;
      border-bottom:3px solid #0b4f8a;
      padding-bottom:10px;
      margin-bottom:12px;
    }
    .header-text{ display:flex; flex-direction:column; gap:6px; }
    .hdr-logo{ height:75px; width:auto; justify-self:end; }

    /* Footer inside page */
    .footer{
      position:absolute;
      left:18px;
      right:18px;
      bottom:18px;
      background:#fff;
      z-index:2;
    }
    .footer-table{
      width:100% !important;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:12px;
    }
    .footer-table th, .footer-table td{
      border:1px solid #6b7280;
      padding:6px 8px;
      text-align:center;
      font-weight:600;
      color:#4b5563;
    }
    .footer-table th{
      background:#ffffff !important;
      color:#6b7280;
      font-weight:700;
    }

    /* Hidden report container used for PDF rendering */
    #pdfReportWrapper{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px; /* ~A4 @ 96dpi */
      background:#fff;
      color:#000;
    }
    #pdfReport{
      padding:18px;
      border:1px solid #000;
      width: 794px;
      box-sizing:border-box;
      font-family: Arial, Helvetica, sans-serif;
    }
    .r-title{
      font-weight:700;
      font-size:15px;
      text-align:center;
      margin:8px 0 12px;
      text-decoration:underline;
    }
    .r-org{
      font-weight:700;
      font-size:16px;
      color:#0b4f8a;
    }
    .r-meta{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:8px;
      margin:10px 0 12px;
      font-size:12px;
    }
    .r-meta div{ border:1px solid #ddd; padding:6px; }
    .r-sec{
      background:#e8f1fb;
      border:1px solid #0b4f8a;
      color:#0b4f8a;
      font-weight:700;
      padding:6px 10px;
      margin:14px 0 8px;
    }
    .r-table th, .r-table td{ border:1px solid #000; padding:6px; font-size:11px; vertical-align:top; }
    .r-table th{ background:#f2f2f2; }
    .r-thumb{
      width:110px;
      height:75px;
      border:1px solid #bbb;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#fff;
    }
    .r-thumb img{ width:100%; height:100%; object-fit:cover; }

  </style>
</head>

<body>
  <div class="page">
    <div class="header header-with-logo">
      <div class="header-text">
        <div class="org">CSP Abu Dhabi Terminal Environment, Health and Safety Management</div>
        <div class="title">Quay crane (QC) Inspection checklist</div>
      </div>
      <img class="hdr-logo" src="logo.png" alt="CSPADT Logo">
    </div>

    <!-- ✅ IMPORTANT: form is NOT posted directly now (PDF is generated + sent via fetch) -->
    <form id="qcForm" onsubmit="return false;">
      <div class="meta">
        <div class="field">
          <label>QC No</label>
          <select name="qcNo" required>
            <option value="">Select QC</option>
            <option>QC 101</option><option>QC 102</option><option>QC 103</option><option>QC 104</option><option>QC 105</option>
            <option>QC 106</option><option>QC 107</option><option>QC 108</option><option>QC 109</option><option>QC 110</option><option>QC 111</option>
          </select>
        </div>

        <div class="field"><label>Date Inspected</label><input type="date" name="dateInspected" class="locked" readonly /></div>
        <div class="field"><label>Time</label><input type="time" name="timeInspected" class="locked" readonly /></div>
        <div class="field"><label>Location</label><input type="text" name="location" /></div>
        <div class="field"><label>Inspector Name</label><input type="text" name="inspectorName" /></div>
        <div class="field"><label>Department / Company</label><input type="text" name="company" /></div>
        <div class="field"><label>Weather</label>
          <select name="weather">
            <option value="">Select</option><option>Clear</option><option>Sunny</option><option>Windy</option><option>Dusty</option><option>Rain</option><option>Humid</option>
          </select>
        </div>
        <div class="field"><label>Shift</label>
          <select name="shift">
            <option value="">Select</option><option>Day</option><option>Night</option>
          </select>
        </div>
      </div>

      <div class="section-title">Checklist</div>
      <table id="checklistTable">
        <thead>
          <tr>
            <th class="w-sn">S/N</th>
            <th>Inspection Item</th>
            <th class="w-cond">Condition</th>
            <th>Remarks / Corrective Action</th>
            <th class="w-photo">Photos</th>
          </tr>
        </thead>
        <tbody>
          <!-- ===== Your 30 rows (same as you pasted) ===== -->
          <!-- Row 1 -->
          <tr>
            <td class="center">1</td>
            <td>Crane identification number and SWL load charts clearly displayed?</td>
            <td class="center">
              <label class="opt"><input type="radio" name="cond_1" value="Yes"> Yes</label>
              <label class="opt"><input type="radio" name="cond_1" value="No"> No</label>
              <label class="opt"><input type="radio" name="cond_1" value="NA"> N/A</label>
            </td>
            <td><textarea class="chk-remarks" name="remarks_1" placeholder="Finding / action / responsible / due date"></textarea></td>
            <td>
              <div class="photo-cell">
                <input type="file" accept="image/*" data-preview="c1" />
                <div class="thumb" id="c1">No image</div>
              </div>
            </td>
          </tr>

          <!-- ✅ Keep your rows 2...30 as-is (only change your NOT_Yes to No if you want) -->
          <!-- IMPORTANT: Your file inputs MUST have data-preview="c2"..."c30" and thumb div id="c2"..."c30" -->

          <!-- (Paste your remaining rows 2..30 here unchanged) -->
        </tbody>
      </table>

      <div class="section-title">Observations / Recommendations</div>
      <table>
        <thead>
          <tr>
            <th class="w-sn">S/N</th>
            <th>Observations</th>
            <th class="w-photo">Photos</th>
            <th>Recommendations</th>
            <th class="w-status">Status</th>
            <th class="center" style="width:90px;">Action</th>
          </tr>
        </thead>
        <tbody id="obsBody"></tbody>
      </table>

      <div style="margin:10px 0; text-align:right;">
        <button type="button" id="addObsRowBtn" class="secondary">Add New Observation Row</button>
      </div>

      <div class="section-title">Signatures</div>
      <div class="sign-grid">
        <div class="sigbox">
          <b>HSE Inspector</b><br><br>
          <label>HSE Inspector Name</label>
          <input type="text" name="hseInspectorName" placeholder="Type name" />
          <div style="margin-top:10px;">
            <canvas id="sig1"></canvas>
            <input type="hidden" name="sig_hseInspector" id="sig_hseInspector" />
          </div>
          <div style="margin-top:8px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div><b>Date:</b> <input type="date" name="hseInspectorSignDate" style="width:170px" /></div>
            <div>
              <button type="button" class="secondary" onclick="clearSig('sig1','sig_hseInspector')">Clear</button>
            </div>
          </div>
        </div>

        <div class="sigbox">
          <b>HSSE Manager (HSSEM)</b><br><br>
          <label>HSSE Manager Name</label>
          <input type="text" name="hsseManagerName" placeholder="Type name" />
          <div style="margin-top:10px;">
            <canvas id="sig2"></canvas>
            <input type="hidden" name="sig_hsseManager" id="sig_hsseManager" />
          </div>
          <div style="margin-top:8px; display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div><b>Date:</b> <input type="date" name="hsseManagerSignDate" style="width:170px" /></div>
            <div>
              <button type="button" class="secondary" onclick="clearSig('sig2','sig_hsseManager')">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" onclick="generateAndSendPDF()">Send (Auto PDF + Email)</button>
        <button type="button" class="secondary" onclick="resetAll()">Clear Form</button>
      </div>

      <!-- FOOTER -->
      <div class="footer">
        <table class="footer-table" aria-label="Document Footer">
          <thead>
            <tr>
              <th>Prepared By</th>
              <th>Reviewed By</th>
              <th>Page No</th>
              <th>Revision</th>
              <th>Control #</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="ft-val">HSSE Committee Team</td>
              <td class="ft-val">Abdul Rouf</td>
              <td class="ft-val">Page 1 of 2</td>
              <td class="ft-val">1.0</td>
              <td class="ft-val">CSP-HSSE-FRM-076</td>
            </tr>
          </tbody>
        </table>
      </div>
    </form>
  </div>

  <!-- ✅ Hidden render area for “beautiful PDF” -->
  <div id="pdfReportWrapper">
    <div id="pdfReport"></div>
  </div>

  <script>
    /* ===========================
       ✅ PASTE YOUR GOOGLE WEB APP URL HERE
       (Deploy Apps Script as Web App -> /exec URL)
       =========================== */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwDEAoKz0XmkJIpyzglsmlxvb5GNP2zfk1U4jlae5PMZjFxb7F0ZvNMfhCQVhzJQiKw/exec";

    // Photo preview on screen
    document.addEventListener('change', function(e){
      const inp = e.target;
      if(inp && inp.matches('input[type="file"][data-preview]')){
        const id = inp.getAttribute('data-preview');
        const box = document.getElementById(id);
        const file = inp.files && inp.files[0];
        if(!box) return;
        if(!file){ box.textContent = "No image"; return; }
        const url = URL.createObjectURL(file);
        box.innerHTML = '<img alt="preview" src="' + url + '">';
      }
    });

    // Auto-fill Date + Time on open
    document.addEventListener('DOMContentLoaded', () => {
      const dInp = document.querySelector('input[name="dateInspected"]');
      const tInp = document.querySelector('input[name="timeInspected"]');
      const now = new Date();

      if(dInp && !dInp.value){
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        dInp.value = `${yyyy}-${mm}-${dd}`;
      }
      if(tInp && !tInp.value){
        const hh = String(now.getHours()).padStart(2,'0');
        const mi = String(now.getMinutes()).padStart(2,'0');
        tInp.value = `${hh}:${mi}`;
      }

      const addBtn = document.getElementById('addObsRowBtn');
      if(addBtn) addBtn.addEventListener('click', addObservationRow);

      const tbody = document.getElementById('obsBody');
      if(tbody){
        tbody.innerHTML = '';
        addObservationRow(); // ONLY ONE DEFAULT ROW
      }
      renumberObservationRows();

      setupPad('sig1','sig_hseInspector');
      setupPad('sig2','sig_hsseManager');
    });

    // Observations add/delete + renumber
    function addObservationRow(){
      const tbody = document.getElementById('obsBody');
      if(!tbody) return;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="center"></td>
        <td><textarea class="obs-ta" name="" placeholder="Describe observation"></textarea></td>
        <td>
          <div class="photo-cell">
            <input type="file" accept="image/*" data-preview="" />
            <div class="thumb">No image</div>
          </div>
        </td>
        <td><textarea class="rec-ta" name="" placeholder="Recommendation / corrective action"></textarea></td>
        <td>
          <select name="">
            <option value="">Select</option>
            <option>Open</option>
            <option>In Progress</option>
            <option>Closed</option>
          </select>
        </td>
        <td class="center"><button type="button" class="secondary danger obs-del-btn">Delete</button></td>
      `.trim();

      tbody.appendChild(tr);
      renumberObservationRows();
    }

    document.addEventListener('click', (e) => {
      const btn = e.target;
      if(btn && btn.classList && btn.classList.contains('obs-del-btn')){
        const tr = btn.closest('tr');
        if(tr){
          tr.remove();
          renumberObservationRows();
        }
      }
    });

    function renumberObservationRows(){
      const tbody = document.getElementById('obsBody');
      if(!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach((tr, idx) => {
        const n = idx + 1;
        const snCell = tr.querySelector('td');
        if(snCell) snCell.textContent = n;

        const obs = tr.querySelector('textarea.obs-ta');
        const rec = tr.querySelector('textarea.rec-ta');
        const status = tr.querySelector('select');

        if(obs) obs.name = `obs_${n}`;
        if(rec) rec.name = `rec_${n}`;
        if(status) status.name = `status_${n}`;

        const file = tr.querySelector('input[type="file"][data-preview]');
        const thumb = tr.querySelector('.thumb');
        const pid = `o${n}`;

        if(file) file.setAttribute('data-preview', pid);
        if(thumb){
          thumb.id = pid;
          if(!thumb.querySelector('img')) thumb.textContent = "No image";
        }
      });
    }

    function resetAll(){
      if(confirm("Clear everything?")){
        document.getElementById('qcForm').reset();
        document.querySelectorAll('.thumb').forEach(t => t.textContent = "No image");
        clearSig('sig1','sig_hseInspector');
        clearSig('sig2','sig_hsseManager');

        // re-add only one observation row
        const tbody = document.getElementById('obsBody');
        if(tbody){
          tbody.innerHTML = '';
          addObservationRow();
        }
      }
    }

    // Signatures
    function setupPad(canvasId, hiddenId){
      const canvas = document.getElementById(canvasId);
      const hidden = document.getElementById(hiddenId);
      const ctx = canvas.getContext('2d');
      let drawing = false;

      function resize(){
        const rect = canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        canvas.width = Math.floor(rect.width * ratio);
        canvas.height = Math.floor(rect.height * ratio);
        ctx.setTransform(ratio,0,0,ratio,0,0);
        ctx.lineWidth = 2.2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#000';
      }

      function pos(ev){
        const r = canvas.getBoundingClientRect();
        const e = ev.touches ? ev.touches[0] : ev;
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }

      function start(ev){ ev.preventDefault(); drawing = true; const p = pos(ev); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
      function move(ev){ if(!drawing) return; ev.preventDefault(); const p = pos(ev); ctx.lineTo(p.x,p.y); ctx.stroke(); }
      function end(ev){
        if(!drawing) return;
        ev.preventDefault();
        drawing = false;
        if(hidden) hidden.value = canvas.toDataURL('image/png');
      }

      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('mousemove', move);
      window.addEventListener('mouseup', end);

      canvas.addEventListener('touchstart', start, {passive:false});
      canvas.addEventListener('touchmove', move, {passive:false});
      window.addEventListener('touchend', end, {passive:false});

      resize();
      window.addEventListener('resize', resize);
    }

    function clearSig(canvasId, hiddenId){
      const c = document.getElementById(canvasId);
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      const h = document.getElementById(hiddenId);
      if(h) h.value = '';
    }

    // Helpers
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function getVal(name){
      const el = document.querySelector(`[name="${name}"]`);
      return el ? el.value : "";
    }
    function getRadio(name){
      const r = document.querySelector(`input[name="${name}"]:checked`);
      return r ? r.value : "";
    }
    function readAsDataURL(file){
      return new Promise((resolve) => {
        if(!file) return resolve("");
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result || "");
        fr.onerror = () => resolve("");
        fr.readAsDataURL(file);
      });
    }

    // ✅ MAIN: Generate beautiful PDF + send to Google Script (email with attachment)
    async function generateAndSendPDF(){
      if(WEB_APP_URL.includes("PASTE_YOUR_GOOGLE_WEB_APP_URL_HERE")){
        alert("Paste your Google Web App URL inside WEB_APP_URL first.");
        return;
      }

      // basic required field
      const qcNo = getVal("qcNo");
      if(!qcNo){
        alert("Please select QC No.");
        return;
      }

      const meta = {
        qcNo,
        dateInspected: getVal("dateInspected"),
        timeInspected: getVal("timeInspected"),
        location: getVal("location"),
        inspectorName: getVal("inspectorName"),
        company: getVal("company"),
        weather: getVal("weather"),
        shift: getVal("shift"),
        hseInspectorName: getVal("hseInspectorName"),
        hseInspectorSignDate: getVal("hseInspectorSignDate"),
        hsseManagerName: getVal("hsseManagerName"),
        hsseManagerSignDate: getVal("hsseManagerSignDate"),
        sigHse: getVal("sig_hseInspector"),
        sigHsse: getVal("sig_hsseManager")
      };

      // Collect checklist rows
      const checklistRows = Array.from(document.querySelectorAll("#checklistTable tbody tr"));
      const checklistData = [];
      for(const tr of checklistRows){
        const sn = (tr.children[0]?.textContent || "").trim();
        const item = (tr.children[1]?.textContent || "").trim();

        // radio name is cond_SN
        const cond = getRadio(`cond_${sn}`);
        const remarks = tr.querySelector(`textarea[name="remarks_${sn}"]`)?.value || "";

        const fileInp = tr.querySelector('input[type="file"][data-preview]');
        const imgData = fileInp && fileInp.files && fileInp.files[0] ? await readAsDataURL(fileInp.files[0]) : "";

        checklistData.push({sn, item, cond, remarks, imgData});
      }

      // Collect observation rows
      const obsRows = Array.from(document.querySelectorAll("#obsBody tr"));
      const obsData = [];
      for(let i=0;i<obsRows.length;i++){
        const tr = obsRows[i];
        const n = i+1;

        const obs = tr.querySelector(`textarea[name="obs_${n}"]`)?.value || "";
        const rec = tr.querySelector(`textarea[name="rec_${n}"]`)?.value || "";
        const status = tr.querySelector(`select[name="status_${n}"]`)?.value || "";

        const fileInp = tr.querySelector('input[type="file"][data-preview]');
        const imgData = fileInp && fileInp.files && fileInp.files[0] ? await readAsDataURL(fileInp.files[0]) : "";

        obsData.push({sn:n, obs, rec, status, imgData});
      }

      // Build PDF report HTML (clean + thumbnails)
      const report = document.getElementById("pdfReport");
      report.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div>
            <div class="r-org">CSP Abu Dhabi Terminal Environment, Health and Safety Management</div>
            <div class="r-title">Quay crane (QC) Inspection checklist</div>
          </div>
          <div>
            <img src="logo.png" style="height:65px; width:auto;" alt="CSPADT Logo">
          </div>
        </div>

        <div class="r-meta">
          <div><b>QC No:</b> ${esc(meta.qcNo)}</div>
          <div><b>Date / Time:</b> ${esc(meta.dateInspected)} ${esc(meta.timeInspected)}</div>
          <div><b>Location:</b> ${esc(meta.location)}</div>
          <div><b>Inspector Name:</b> ${esc(meta.inspectorName)}</div>
          <div><b>Dept / Company:</b> ${esc(meta.company)}</div>
          <div><b>Weather / Shift:</b> ${esc(meta.weather)} / ${esc(meta.shift)}</div>
        </div>

        <div class="r-sec">Checklist</div>
        <table class="r-table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="width:35px;">S/N</th>
              <th>Inspection Item</th>
              <th style="width:70px;">Cond.</th>
              <th>Remarks</th>
              <th style="width:120px;">Photo</th>
            </tr>
          </thead>
          <tbody>
            ${checklistData.map(r => `
              <tr>
                <td class="center">${esc(r.sn)}</td>
                <td>${esc(r.item)}</td>
                <td class="center">${esc(r.cond)}</td>
                <td>${esc(r.remarks)}</td>
                <td>
                  <div class="r-thumb">
                    ${r.imgData ? `<img src="${r.imgData}" alt="photo">` : `<span style="color:#777;">No image</span>`}
                  </div>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <div class="r-sec">Observations / Recommendations</div>
        <table class="r-table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="width:35px;">S/N</th>
              <th>Observation</th>
              <th style="width:120px;">Photo</th>
              <th>Recommendation</th>
              <th style="width:70px;">Status</th>
            </tr>
          </thead>
          <tbody>
            ${obsData.map(r => `
              <tr>
                <td class="center">${esc(r.sn)}</td>
                <td>${esc(r.obs)}</td>
                <td>
                  <div class="r-thumb">
                    ${r.imgData ? `<img src="${r.imgData}" alt="photo">` : `<span style="color:#777;">No image</span>`}
                  </div>
                </td>
                <td>${esc(r.rec)}</td>
                <td class="center">${esc(r.status)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>

        <div class="r-sec">Signatures</div>
        <table class="r-table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>HSE Inspector</th>
              <th>HSSE Manager (HSSEM)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <b>Name:</b> ${esc(meta.hseInspectorName)}<br>
                <b>Date:</b> ${esc(meta.hseInspectorSignDate)}<br><br>
                ${meta.sigHse ? `<img src="${meta.sigHse}" style="width:100%; max-height:110px; border:1px solid #000;" alt="sig">` : `<span style="color:#777;">No signature</span>`}
              </td>
              <td>
                <b>Name:</b> ${esc(meta.hsseManagerName)}<br>
                <b>Date:</b> ${esc(meta.hsseManagerSignDate)}<br><br>
                ${meta.sigHsse ? `<img src="${meta.sigHsse}" style="width:100%; max-height:110px; border:1px solid #000;" alt="sig">` : `<span style="color:#777;">No signature</span>`}
              </td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top:12px;">
          <table class="r-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>Prepared By</th>
                <th>Reviewed By</th>
                <th>Revision</th>
                <th>Control #</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="center">HSSE Committee Team</td>
                <td class="center">Abdul Rouf</td>
                <td class="center">1.0</td>
                <td class="center">CSP-HSSE-FRM-076</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      // Render to PDF (multi-page supported)
      const { jsPDF } = window.jspdf;
      const canvas = await html2canvas(report, {scale: 2, backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/jpeg", 0.95);

      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = 210;
      const pageHeight = 297;

      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

      let heightLeft = imgHeight;
      let position = 0;

      pdf.addImage(imgData, "JPEG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "JPEG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      const fileName = `QC-Inspection-${meta.qcNo}-${meta.dateInspected}.pdf`;
      const pdfBase64 = pdf.output("datauristring").split(",")[1];

      // Send to Apps Script (email attachment)
      try{
        // no-cors avoids CORS issues on Apps Script, email still sends
        await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            to: "saleh.shaikh@cspadt.ae",
            subject: `QC Inspection Checklist - ${meta.qcNo} - ${meta.dateInspected}`,
            bodyHtml: `<p>Please find attached the QC Inspection Checklist PDF.</p>
                       <p><b>QC:</b> ${esc(meta.qcNo)}<br>
                       <b>Date/Time:</b> ${esc(meta.dateInspected)} ${esc(meta.timeInspected)}<br>
                       <b>Inspector:</b> ${esc(meta.inspectorName)}</p>`,
            filename: fileName,
            pdfBase64: pdfBase64
          })
        });

        alert("✅ Sent! Email with PDF attachment is on the way.");
      }catch(err){
        alert("Failed to send. Check Web App URL & deployment permissions.");
      }
    }
  </script>
</body>
</html>
